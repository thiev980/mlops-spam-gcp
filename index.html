<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="robots" content="index, follow">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Spam Classifier — Daily Metrics</title>

  <!-- Open Graph / Twitter (für schöne Previews beim Teilen) -->
  <meta property="og:title" content="Spam Classifier — Daily Metrics">
  <meta property="og:description" content="End-to-end MLOps demo: Airflow, MLflow, Grafana & GitHub Actions. Live model performance updated daily.">
  <meta property="og:url" content="https://thiev980.github.io/mlops-spam-gcp/">
  <meta property="og:image" content="https://thiev980.github.io/mlops-spam-gcp/metrics_trend.png">
  <meta name="twitter:card" content="summary_large_image">

  <link rel="preconnect" href="https://cdn.jsdelivr.net"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --bg:#fff; --fg:#111; --muted:#666; --card:#fff; --line:#eee; --pill:#f5f5f5; }
    @media (prefers-color-scheme: dark) {
      :root { --bg:#0f1115; --fg:#e8e8ea; --muted:#9aa0a6; --card:#151821; --line:#222733; --pill:#202532; }
    }
    *{box-sizing:border-box}
    body { margin: 24px; background: var(--bg); color: var(--fg); font: 16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    a{ color:#4ea1ff; text-decoration:none; }
    .wrap { max-width: 1100px; margin: 0 auto; display: grid; gap: 22px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap; }
    .badges a { margin-right:10px; display:inline-block }
    .card { background: var(--card); border:1px solid var(--line); border-radius: 14px; padding:16px; box-shadow: 0 1px 6px rgba(0,0,0,.05);}
    .muted { color: var(--muted); }
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:var(--pill)}
    .kpis { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); }
    .kpi { padding:12px;border:1px solid var(--line); border-radius:12px; background:var(--bg); }
    .kpi .label{color:var(--muted); font-size:13px;}
    .kpi .val{font-size:22px; font-weight:600}
    .grid2 { display:grid; gap:22px; grid-template-columns: 1fr; }
    @media (min-width: 980px){ .grid2{ grid-template-columns: 1.35fr .85fr; } }
    table { width:100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 8px 10px; border-bottom: 1px solid var(--line); text-align: right; }
    th:first-child, td:first-child { text-align: left; }
    footer { color: var(--muted); font-size: 14px; text-align:center; padding: 18px 0; }
    .section-title{ margin:0 0 10px 0 }
    .subtle{ font-size:14px; color:var(--muted) }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1 style="margin:0 0 6px 0;">Spam Classifier — Daily Metrics</h1>
        <div class="muted" id="meta">Loading…</div>
      </div>
      <div class="badges">
        <!-- Status badges -->
        <a href="https://github.com/thiev980/mlops-spam-gcp/actions/workflows/update-metrics.yml" title="Daily metrics update">
          <img src="https://github.com/thiev980/mlops-spam-gcp/actions/workflows/update-metrics.yml/badge.svg" alt="Daily Metrics Update">
        </a>
        <a href="https://thiev980.github.io/mlops-spam-gcp/" title="Live metrics">
          <img src="https://img.shields.io/badge/live%20metrics-online-success" alt="GitHub Pages">
        </a>
      </div>
    </header>

    <section class="card">
      <div class="kpis" id="kpis"></div>
    </section>

    <section class="grid2">
      <div class="card">
        <h3 class="section-title">F1 / Precision / Recall</h3>
        <div class="subtle">Daily snapshot (last 30 days)</div>
        <canvas id="chart"></canvas>
      </div>

      <div class="card">
        <h3 class="section-title">About this project</h3>
        <p class="subtle">End-to-end MLOps demo: Airflow orchestrates daily evaluation, metrics land in PostgreSQL, MLflow manages model & threshold artifact, Grafana visualizes trends, GitHub Actions exports metrics to JSON, GitHub Pages hosts this dashboard.</p>
        <ul class="subtle" style="margin-top:8px; line-height:1.6">
          <li><b>Stack:</b> Airflow, MLflow, Grafana, PostgreSQL, GitHub Actions, GitHub Pages</li>
          <li><b>Schedule:</b> 03:05 UTC daily (CI fetch + deploy)</li>
          <li><b>Repo:</b> <a href="https://github.com/thiev980/mlops-spam-gcp" target="_blank" rel="noopener">thiev980/mlops-spam-gcp</a></li>
          <li><b>Owner:</b> <a href="https://github.com/thiev980" target="_blank" rel="noopener">Thierry Figini</a> · <a href="https://www.linkedin.com/in/thierryfigini/" target="_blank" rel="noopener">LinkedIn</a></li>
        </ul>
      </div>
    </section>

    <section class="card">
      <h3 class="section-title">Latest 10 runs</h3>
      <table id="tbl">
        <thead>
          <tr>
            <th>Date</th><th>F1</th><th>Prec</th><th>Rec</th><th>ROC-AUC</th>
            <th>Thr used</th><th>Thr sugg</th><th>N</th><th>TP</th><th>TN</th><th>FP</th><th>FN</th><th>Spam rate</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="subtle">Source: Airflow → Postgres → export → GitHub Pages (auto-update).</p>
    </section>

    <footer>
      © <span id="y"></span> Thierry Figini · <a href="https://github.com/thiev980/mlops-spam-gcp" target="_blank" rel="noopener">GitHub</a>
    </footer>
  </div>

<script>
document.getElementById('y').textContent = new Date().getFullYear();

async function main(){
  try{
    const res = await fetch('metrics.json', {cache: 'no-store'});
    const rows = await res.json();
    if(!rows.length){ document.getElementById('meta').textContent='No data'; return; }

    // sort by date just in case
    rows.sort((a,b)=> (a.ds<b.ds?-1:1));
    const last = rows[rows.length-1];

    // Meta
    document.getElementById('meta').innerHTML =
      `Latest: <span class="pill">${last.ds}</span> &nbsp;|&nbsp;
       Threshold used: <b>${fmt(last.threshold_used,3)}</b> &nbsp;|&nbsp;
       Suggested: <b>${last.suggested_threshold!=null ? Number(last.suggested_threshold).toFixed(3) : '—'}</b>`;

    // KPIs
    const kpis = [
      ["F1", last.f1],["Precision", last.precision],["Recall", last.recall],["ROC-AUC", last.roc_auc],
      ["Spam rate", last.spam_rate],["N", last.n],["TP", last.tp],["TN", last.tn],["FP", last.fp],["FN", last.fn],
    ];
    document.getElementById('kpis').innerHTML = kpis.map(([k,v]) =>
      `<div class="kpi"><div class="label">${k}</div><div class="val">${v==null?'—':(typeof v==='number'?fmt(v,3):v)}</div></div>`
    ).join('');

    // Chart (last 30)
    const lastN = rows.slice(-30);
    const labels = lastN.map(r=>r.ds);
    const f1  = lastN.map(r=>r.f1);
    const prec= lastN.map(r=>r.precision);
    const rec = lastN.map(r=>r.recall);
    const ctx = document.getElementById('chart').getContext('2d');
    new Chart(ctx, {
      type:'line',
      data:{ labels,
        datasets:[
          {label:'F1', data:f1},
          {label:'Precision', data:prec},
          {label:'Recall', data:rec},
        ]
      },
      options:{ responsive:true, interaction:{mode:'index', intersect:false},
        scales:{ y:{ min:0, max:1 } }
      }
    });

    // Table (latest 10)
    const last10 = rows.slice(-10).reverse();
    const tbody = document.querySelector('#tbl tbody');
    tbody.innerHTML = last10.map(r=>`
      <tr>
        <td>${r.ds}</td>
        <td>${fmt(r.f1)}</td><td>${fmt(r.precision)}</td><td>${fmt(r.recall)}</td><td>${fmt(r.roc_auc)}</td>
        <td>${fmt(r.threshold_used,3)}</td><td>${fmt(r.suggested_threshold,3)}</td>
        <td>${r.n??'—'}</td><td>${r.tp??'—'}</td><td>${r.tn??'—'}</td><td>${r.fp??'—'}</td><td>${r.fn??'—'}</td>
        <td>${fmt(r.spam_rate)}</td>
      </tr>`).join('');
  }catch(e){
    document.getElementById('meta').textContent='Failed to load metrics.json';
    console.error(e);
  }
}
function fmt(v, d=3){ return (v==null||isNaN(v))?'—':Number(v).toFixed(d); }
main();
</script>
</body>
</html>