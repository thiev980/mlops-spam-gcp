<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Spam Classifier – Daily Metrics</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; color: #111; }
    .grid { display: grid; gap: 20px; grid-template-columns: 1fr; max-width: 1100px; }
    .card { border: 1px solid #eee; border-radius: 14px; padding: 16px; box-shadow: 0 1px 6px rgba(0,0,0,.05);}
    .kpis { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); }
    .muted { color:#666; }
    table { width:100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #eee; text-align: right; }
    th:first-child, td:first-child { text-align: left; }
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#f5f5f5}
    a{ color:#0b5bd3; text-decoration:none;}
  </style>
</head>
<body>
  <div class="grid">
    <div class="card">
      <h1>Spam Classifier – Daily Metrics</h1>
      <div id="meta" class="muted">Loading…</div>
      <div class="kpis" id="kpis"></div>
    </div>

    <div class="card">
      <h3>F1 / Precision / Recall (daily)</h3>
      <canvas id="chart"></canvas>
    </div>

    <div class="card">
      <h3>Latest 10 runs</h3>
      <table id="tbl">
        <thead>
          <tr>
            <th>Date</th><th>F1</th><th>Prec</th><th>Rec</th><th>ROC-AUC</th>
            <th>Thr used</th><th>Thr sugg</th><th>N</th><th>TP</th><th>TN</th><th>FP</th><th>FN</th><th>Spam rate</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="muted">Source: daily pipeline (Airflow → MLflow → eval). Repo: <a href="https://github.com/thiev980/mlops-spam-gcp" target="_blank">mlops-spam-gcp</a></p>
    </div>
  </div>

<script>
async function main(){
  const res = await fetch('metrics.json', {cache: 'no-store'});
  const rows = await res.json();
  if(!rows.length){ document.getElementById('meta').textContent='No data'; return; }

  const last = rows[rows.length-1];
  const meta = document.getElementById('meta');
  meta.innerHTML = `
    Latest: <span class="pill">${last.ds}</span> &nbsp;|&nbsp;
    Threshold used: <b>${Number(last.threshold_used ?? 0).toFixed(3)}</b> &nbsp;|&nbsp;
    Suggested: <b>${last.suggested_threshold!=null ? Number(last.suggested_threshold).toFixed(3) : '—'}</b>
  `;

  // KPIs
  const kpis = [
    ["F1", last.f1],["Precision", last.precision],["Recall", last.recall],["ROC-AUC", last.roc_auc],
    ["Spam rate", last.spam_rate],["N", last.n]
  ];
  document.getElementById('kpis').innerHTML = kpis.map(([k,v]) =>
    `<div class="card"><div class="muted">${k}</div><div style="font-size:22px;font-weight:600">${v==null?'—':(typeof v==='number'?v.toFixed(3):v)}</div></div>`
  ).join('');

  // Chart
  const labels = rows.map(r=>r.ds);
  const f1  = rows.map(r=>r.f1);
  const prec= rows.map(r=>r.precision);
  const rec = rows.map(r=>r.recall);
  const ctx = document.getElementById('chart').getContext('2d');
  new Chart(ctx, {
    type:'line',
    data:{ labels,
      datasets:[
        {label:'F1', data:f1},
        {label:'Precision', data:prec},
        {label:'Recall', data:rec},
      ]
    },
    options:{ responsive:true, interaction:{mode:'index', intersect:false},
      scales:{ y:{ min:0, max:1 } }
    }
  });

  // Table
  const last10 = rows.slice(-10).reverse();
  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML = last10.map(r=>`
    <tr>
      <td>${r.ds}</td>
      <td>${fmt(r.f1)}</td><td>${fmt(r.precision)}</td><td>${fmt(r.recall)}</td><td>${fmt(r.roc_auc)}</td>
      <td>${fmt(r.threshold_used,3)}</td><td>${fmt(r.suggested_threshold,3)}</td>
      <td>${r.n??'—'}</td><td>${r.tp??'—'}</td><td>${r.tn??'—'}</td><td>${r.fp??'—'}</td><td>${r.fn??'—'}</td>
      <td>${fmt(r.spam_rate)}</td>
    </tr>`).join('');
}
function fmt(v, d=3){ return (v==null||isNaN(v))?'—':Number(v).toFixed(d); }
main();
</script>
</body>
</html>
